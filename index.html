<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å†…ç˜ç«¶è¼ª</title>
<style>
  body{font-family: sans-serif; text-align:center; background:#fafafa}
  canvas{border:1px solid #333; background:#fff; display:block; margin:12px auto}
  .controls{width:90%; max-width:760px; margin:8px auto}
  .player{margin:6px 0}
  table{border-collapse:collapse; margin:12px auto}
  td,th{border:1px solid #666; padding:6px 8px}
</style>
</head>
<body>
<h1>å†…ç˜ç«¶è¼ª</h1>
<div class="controls">
  <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ï¼š</label>
  <select id="playerCount"><option>1</option><option>2</option><option>3</option><option>4</option></select>
  <button id="setupBtn">è¨­å®š</button>
</div>

<div id="betArea" class="controls"></div>
<canvas id="race" width="760" height="340"></canvas>
<div class="controls">
  <button id="startBtn" style="display:none">ğŸ ãƒ¬ãƒ¼ã‚¹é–‹å§‹</button>
  <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
  <p id="result"></p>
</div>

<h3>è„šè³ª</h3>
<table><tr><th>é¸æ‰‹</th><th>è„šè³ª</th><th>ç‰¹å¾´</th></tr>
<tr><td style="color:red">é•·ç”°</td><td>ã‚¹ã‚¿ãƒ¼ãƒˆå‹</td><td>åºç›¤é€Ÿã„ãŒå¾ŒåŠå¤±é€Ÿ</td></tr>
<tr><td style="color:blue">ä¸Šè°·</td><td>ä¸­ç›¤å‹</td><td>ä¸­ç›¤ã§åŠ é€Ÿ</td></tr>
<tr><td style="color:green">é•·äº•</td><td>è¿½ã„è¾¼ã¿å‹</td><td>çµ‚ç›¤ã«å¼·ã„</td></tr>
<tr><td style="color:orange">çŸ¢éƒ¨</td><td>ãƒãƒ†å‹</td><td>æœ€åˆé€Ÿã„ãŒã™ãæ¸›é€Ÿ</td></tr>
<tr><td style="color:purple">å‚ä¸Š</td><td>ãƒ©ãƒ³ãƒ€ãƒ å‹</td><td>å¸¸ã«å¤‰å‹•</td></tr>
</table>

<script>
// ----- ãƒ©ãƒ³ãƒŠãƒ¼å®šç¾©ï¼ˆç”»åƒè¨­å®šï¼‰ -----
const horses = [
  {name:"é•·ç”°", type:"start", x:0, y:50, img:new Image()},
  {name:"ä¸Šè°·", type:"mid", x:0, y:110, img:new Image()},
  {name:"é•·äº•", type:"end", x:0, y:170, img:new Image()},
  {name:"çŸ¢éƒ¨", type:"fade", x:0, y:230, img:new Image()},
  {name:"å‚ä¸Š", type:"random", x:0, y:290, img:new Image()}
];

// ç”»åƒãƒ‘ã‚¹ã‚’è‡ªç”±ã«å¤‰æ›´
horses[0].img.src = 'img/Screenshot 2025-10-27 09.58.20.png';
horses[1].img.src = 'img/Screenshot 2025-10-27 10.09.57.png';
horses[2].img.src = 'img/Screenshot 2025-10-27 09.58.07.png';
horses[3].img.src = 'img/Screenshot 2025-10-27 09.58.15.png';
horses[4].img.src = 'img/Screenshot 2025-10-27 09.57.47.png';

let playerCount = 1;
let bets = [];
let raceInterval = null;
let raceFinished = false;
const canvas = document.getElementById('race');
const ctx = canvas.getContext('2d');
const betArea = document.getElementById('betArea');
const setupBtn = document.getElementById('setupBtn');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const resultP = document.getElementById('result');

// ======================
// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
// ======================
function makeOptionsHTML(){
  return horses.map(h=>`<option value="${h.name}">${h.name}</option>`).join('');
}

function setupPlayers(){
  playerCount = parseInt(document.getElementById('playerCount').value);
  betArea.innerHTML = '';
  bets = [];
  for(let i=0;i<playerCount;i++){
    const div = document.createElement('div');
    div.className = 'player';
    div.innerHTML = `
      <b>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}</b> äºˆæƒ³ï¼ˆ1â†’2â†’3ä½ï¼‰ï¼š
      <select id="p${i}_1">${makeOptionsHTML()}</select>
      <select id="p${i}_2">${makeOptionsHTML()}</select>
      <select id="p${i}_3">${makeOptionsHTML()}</select>
      <button id="p${i}_ok">ãƒ™ãƒƒãƒˆ</button>
      <span id="p${i}_state" style="margin-left:8px;color:#666">æœªãƒ™ãƒƒãƒˆ</span>
    `;
    betArea.appendChild(div);
    div.querySelector(`#p${i}_ok`).addEventListener('click', ()=>{
      const b1 = div.querySelector(`#p${i}_1`).value;
      const b2 = div.querySelector(`#p${i}_2`).value;
      const b3 = div.querySelector(`#p${i}_3`).value;
      bets[i] = [b1,b2,b3];
      div.querySelector(`#p${i}_state`).textContent = `ãƒ™ãƒƒãƒˆæ¸ˆ: ${b1}â†’${b2}â†’${b3}`;
      checkAllBetsDone();
    });
  }
}

function checkAllBetsDone(){
  if(bets.length>=playerCount && bets.slice(0,playerCount).every(b=>Array.isArray(b) && b.length===3)){
    calcOdds();
    startBtn.style.display='inline-block';
  }
}

function calcOdds(){
  const freq = {};
  bets.slice(0,playerCount).forEach(b=>b.forEach(name=>freq[name]=(freq[name]||0)+1));
  const totalBets = playerCount*3 || 1;
  horses.forEach(h=>{
    const p = freq[h.name] || 0.2;
    let raw = (totalBets / p);
    let odds = Math.max(1.2, Math.min(10, raw));
    h.odds = Math.round(odds*10)/10;
  });
  let s = 'ã‚ªãƒƒã‚ºï¼ˆäººæ°—ãŒé«˜ã„ã»ã©ä½å€ç‡ï¼‰:\n';
  horses.forEach(h=> s += `${h.name}: ${h.odds}å€\n`);
  alert(s);
}

// ======================
// ãƒ¬ãƒ¼ã‚¹å‡¦ç†
// ======================
function resetRace(){
  horses.forEach(h=>{h.x=0});
  raceFinished=false;
  clearInterval(raceInterval);
  resultP.textContent='';
  drawFrame();
}

let randomFactors = {}; // å„é¸æ‰‹ã®ä¹±æ•°ç‰¹æ€§

function startRace(){
  resetRace();
  startBtn.style.display='none';
  // å„é¸æ‰‹ã®å€‹åˆ¥ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’åˆæœŸåŒ–
  horses.forEach(h=>{
    h.randomSeed = Math.random() * 1000;
    h.randomBias = Math.random() * 2 - 1; // -1ã€œ1
    h.randomBoost = Math.random() * 3;    // å›ºæœ‰åŠ é€Ÿ
  });
  raceInterval = setInterval(raceFrame,40);
}

function speedPattern(h, progress){
  // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å®Œå…¨ç‹¬ç«‹ä¹±æ•°
  const r = Math.random();
  let base;
  switch(h.type){
    case 'start':  base = 2.8 - 1.8*progress; break;
    case 'mid':    base = (progress<0.5)?1.5:3.3; break;
    case 'end':    base = (progress>0.6)?3.8:1.2; break;
    case 'fade':   base = 3.0 - 2.5*progress; break;
    case 'random': base = 1.8 + Math.random()*2.2; break;
  }

  // å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ãªæ³¢ã¨ãƒã‚¤ã‚º
  const noise = (Math.random() - 0.5) * 4;
  const burst = (r < 0.03) ? (2 + Math.random()*4) : 0;

  // å„ãƒ¬ãƒ¼ã‚¹ã”ã¨ã«å€‹ä½“å·®ã‚’æ³¨å…¥
  if(!h.seed) h.seed = Math.random()*2 - 1;
  return Math.max(0.5, base + noise + burst + h.seed);
}


// æ”¹è‰¯ç‰ˆã‚¹ãƒ”ãƒ¼ãƒ‰é–¢æ•°ï¼ˆã‚†ã‚‰ãï¼‹ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚¢ãƒƒãƒ—ï¼‰
function speedPattern(h, progress){
  let base;
  switch(h.type){
    case 'start':  base = 3.0 - 1.5*progress; break;
    case 'mid':    base = (progress<0.5)?1.5:3.2; break;
    case 'end':    base = (progress>0.6)?3.8:1.2; break;
    case 'fade':   base = 3.2 - 2.8*progress; break;
    case 'random': base = 2.2 + Math.random()*1.5; break;
  }
  const wave = Math.sin(Math.random()*Math.PI*2) * 1.2; // å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ æ³¢
  const noise = (Math.random() - 0.5) * 2.5;            // å¼·ã‚ã®ãƒã‚¤ã‚º
  const burst = Math.random() < 0.05 ? (2 + Math.random()*3) : 0; // ç¨€ã«ã‚¹ãƒ‘ãƒ¼ãƒˆ
  return Math.max(0.5, base + wave + noise + burst);
}


function raceFrame(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  let allFinished = true;
  const finishX = canvas.width - 80;
  horses.forEach(h=>{
    if(h.x < finishX){
      const progress = h.x / finishX;
      h.x += speedPattern(h, progress);
      allFinished = false;
    }
    ctx.drawImage(h.img, h.x+10, h.y-18, 56, 36);
    ctx.fillStyle='#222';
    ctx.font='12px sans-serif';
    ctx.fillText(`${h.name} ${h.odds?('('+h.odds+'å€)'):''}`, Math.max(4,h.x+4), h.y+30);
  });
  if(allFinished && !raceFinished){
    raceFinished = true;
    clearInterval(raceInterval);
    announceResults();
  }
}

function drawFrame(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  horses.forEach(h=>{
    ctx.drawImage(h.img, h.x+10, h.y-18, 56, 36);
    ctx.fillStyle='#222';
    ctx.font='12px sans-serif';
    ctx.fillText(`${h.name} ${h.odds?('('+h.odds+'å€)'):''}`, Math.max(4,h.x+4), h.y+30);
  });
}

// ======================
// çµæœè¡¨ç¤º
// ======================
function announceResults(){
  const order = [...horses].sort((a,b)=>b.x-a.x).map(h=>h.name);
  let res = `ğŸ† çµæœ: ${order.join(' â†’ ')}\n`;
  bets.slice(0,playerCount).forEach((b,i)=>{
    const hit = (b[0]==order[0] && b[1]==order[1] && b[2]==order[2]);
    if(hit){
      const o1 = horses.find(h=>h.name==order[0]).odds || 1;
      const o2 = horses.find(h=>h.name==order[1]).odds || 1;
      const o3 = horses.find(h=>h.name==order[2]).odds || 1;
      const payoff = Math.round((o1*o2*o3)*10)/10;
      res += `ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1} çš„ä¸­ï¼ é…å½“ç›®å®‰: ${payoff}å€\n`;
    }else{
      res += `ğŸ’¸ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1} ã¯ãƒã‚ºãƒ¬\n`;
    }
  });
  resultP.textContent = res;
}

// ======================
setupBtn.addEventListener('click', ()=>{ setupPlayers(); drawFrame(); });
startBtn.addEventListener('click', ()=> startRace());
resetBtn.addEventListener('click', ()=>{ bets=[]; startBtn.style.display='none'; setupPlayers(); resetRace(); });

setupPlayers(); drawFrame();
</script>
</body>
</html>
